import React, { useState } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Timer } from "lucide-react";

import PomodoroTimer from "../components/pomodoro/PomodoroTimer";
import PomodoroStats from "../components/pomodoro/PomodoroStats";
import SessionHistory from "../components/pomodoro/SessionHistory";

export default function PomodoroPage() {
  const queryClient = useQueryClient();
  const [activeSession, setActiveSession] = useState(null);

  const { data: sessions = [], isLoading } = useQuery({
    queryKey: ['pomodoro-sessions'],
    queryFn: () => base44.entities.PomodoroSession.list('-created_date'),
  });

  const createSessionMutation = useMutation({
    mutationFn: (sessionData) => base44.entities.PomodoroSession.create(sessionData),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['pomodoro-sessions'] });
    },
  });

  const updateSessionMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.PomodoroSession.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['pomodoro-sessions'] });
    },
  });

  const handleStartSession = async (config) => {
    const session = await createSessionMutation.mutateAsync({
      task_title: config.taskTitle || "Session de concentration",
      work_duration: config.workDuration,
      break_duration: config.breakDuration,
      category: config.category || "work",
      start_time: new Date().toISOString(),
      completed: false,
    });
    setActiveSession(session);
    return session;
  };

  const handleCompleteSession = async (sessionId) => {
    await updateSessionMutation.mutateAsync({
      id: sessionId,
      data: {
        completed: true,
        end_time: new Date().toISOString(),
      },
    });
    setActiveSession(null);
  };

  return (
    <div className="min-h-screen p-3 md:p-8 bg-gradient-to-br from-red-50 via-white to-orange-50">
      <div className="max-w-6xl mx-auto space-y-4 md:space-y-6">
        {/* Header - Compact */}
        <div className="text-center mb-4 md:mb-8">
          <div className="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-br from-red-600 to-red-700 rounded-2xl md:rounded-3xl flex items-center justify-center mx-auto mb-3 md:mb-4 shadow-xl">
            <Timer className="w-6 h-6 md:w-8 md:h-8 text-white" />
          </div>
          <h1 className="text-2xl md:text-4xl font-bold bg-gradient-to-r from-red-700 to-red-600 bg-clip-text text-transparent mb-1 md:mb-2">
            Pomodoro Focus
          </h1>
          <p className="text-sm md:text-base text-gray-600">Maximisez votre concentration</p>
        </div>

        {/* Stats Overview - Compact */}
        <PomodoroStats sessions={sessions} />

        {/* Main Timer - Toujours visible */}
        <Card className="border-none shadow-2xl">
          <CardHeader className="border-b bg-gradient-to-r from-red-50 to-white p-3 md:p-6">
            <CardTitle className="flex items-center gap-2 text-red-900 text-base md:text-lg">
              <Timer className="w-4 h-4 md:w-5 md:h-5" />
              Session de concentration
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 md:p-8">
            <PomodoroTimer
              activeSession={activeSession}
              onStartSession={handleStartSession}
              onCompleteSession={handleCompleteSession}
            />
          </CardContent>
        </Card>

        {/* Session History - Compact */}
        <SessionHistory sessions={sessions} isLoading={isLoading} />
      </div>
    </div>
  );
}
